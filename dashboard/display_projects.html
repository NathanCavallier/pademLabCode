<body>
    <!-- Afficher la liste des projets en cours -->
    <div id="projectContainer">
    </div>
</body>


<script>
    // Projet: Récurérer les données depuis la base de données et les afficher dans des cellules individuels cliquables pour les modifier
    document.addEventListener('DOMContentLoaded', () => {
        // Déclarer les variables
        var userId;
        var userEmail = '';
        var userRole = '';
        var buttonText = '';

        var numberOfMembers = 0;
        var nomberOfNewReports = 0;
        var numberOfNewMessages = 0;
        var numberOfNewNotifications = 0;

        var colorStatusText = {
            'Pas encore commencé': 'gray',
            'Début': '#29A6A7',
            'En cours': 'green',
            'Terminé': 'red',
            'En pause': 'blue',
            'Annulé': 'gray',
            'Presque terminé': 'orange',
        };
        function getMonth(month) {
            switch (month) {
                case 0:
                    return 'Janvier';
                case 1:
                    return 'Février';
                case 2:
                    return 'Mars';
                case 3:
                    return 'Avril';
                case 4:
                    return 'Mai';
                case 5:
                    return 'Juin';
                case 6:
                    return 'Juillet';
                case 7:
                    return 'Août';
                case 8:
                    return 'Septembre';
                case 9:
                    return 'Octobre';
                case 10:
                    return 'Novembre';
                case 11:
                    return 'Décembre';
            }
        }

        // Récupérer la liste des projets depuis la base de données (à partir de l'API (https://lab.padem.org/wp-json/mo/v1/getProjects))
        // les projets sont affichés dans des lignes individuelles avec un bouton cliquables pour les modifier
        fetch('https://lab.padem.org/wp-json/mo/v1/getProjects', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                var stepper = 0;
                var projectContainer = document.getElementById('projectContainer');
                // Parcourir la liste des projets
                data.forEach(project => {

                    var card = document.createElement('div');
                    card.className = 'card';
                    card.style.borderRadius = '15px';
                    card.style.backgroundColor = 'white';
                    card.style.height = 'auto';
                    card.style.width = 'auto';
                    card.style.margin = '10px';
                    card.style.border = '1px ${colorStatusText[project.project_status]}';

                    var dateDebut = new Date(project.start_date);
                    var dateFin = new Date(project.end_date);
                    var dateDuJour = new Date();

                    var start_date = `${getMonth(dateDebut.getMonth())} ${dateDebut.getFullYear()}`;
                    var end_date = `${dateFin.getDate()} ${getMonth(dateFin.getMonth())} ${dateFin.getFullYear()}`;

                    var dureeTotale = dateFin.getTime() - dateDebut.getTime();
                    var dureeEcoulee = dateDuJour.getTime() - dateDebut.getTime();

                    var progression = (dureeEcoulee / dureeTotale) * 100;

                    function getStatus() {
                        if (progression < 0) {
                            progression = 0;
                            return 'Pas encore commencé';
                        } else if (progression < 25) {
                            return 'Début';
                        } else if (progression > 25 && progression < 50) {
                            return 'En cours';
                        } else if (progression > 50 && progression < 75) {
                            return 'En cours';
                        } else if (progression > 75 && progression < 100) {
                            return 'Presque terminé';
                        } else {
                            return 'Terminé';
                        }
                    }

                    var status = getStatus();

                    var barreProgression = document.createElement('progress');
                    barreProgression.id = 'progress_' + project.project_id;
                    barreProgression.value = progression;
                    barreProgression.max = 100;
                    barreProgression.style.width = '100%';
                    barreProgression.style.height = '10px';
                    barreProgression.style.backgroundColor = 'none';
                    barreProgression.style.borderRadius = '10px';
                    barreProgression.classList.add('animated');
                    setTimeout(function () {
                        barreProgression.classList.remove('animated');
                    }, 1000);

                    card.style.fontSize = '14px'; // Change la taille de la police
                    card.style.fontFamily = 'Arial'; // Change la police
                    card.style.color = 'gray'; // Change la couleur de la police

                    card.innerHTML = `
                        <div class="card">
                            <div id="card-body" class="card-body" style="backgroundColor: none; ">
                                <div style="width: 40%; padding: 5px; background: lightgrey; border-radius: 10px">
                                    <p style="font-weight: lighter; font-size: 10px">${start_date} - ${end_date}</p>
                                </div>
                                <div style="margin-top: 150px; margin-bottom: 10px"></div>
                                <a href='https://lab.padem.org/projet/edit_project.html?project_id=${project.project_id}' style="font-size: 20px; font-weight: bold; color: #29A6A7;">${project.project_title}</a>
                                <div style="margin-top: 0px">
                                    <p style="font-weight: bold;">${project.project_location}</p>
                                </div>
                                ${barreProgression.outerHTML}
                            </div>
                            <div class="card-footer">
                                <p style="font-weight: lighter; color: ${colorStatusText[status]}; margin: 5px; border-radius: 5px; fontSize: 9px;" id="status_${project.project_id}">${parseInt(progression)}% - ${status}</p>
                                <button class="buttonModifier">Voir le projet</button>
                            </div>
                        </div>
                    `;

                    // Ajouter la cellule dans la ligne
                    projectContainer.appendChild(card);

                    // Ajouter un événement de clic sur le bouton "Modifier"    
                    card.querySelector('button').addEventListener('click', () => {
                        // Rediriger l'utilisateur vers la page de modification du projet
                        window.location.href = 'https://lab.padem.org/projet/edit_project.html?project_id=' + project.project_id;
                    });

                    // Ajouter l'image en arrière-plan du card-body
                    /*
                    card.querySelector('#card-body').style.backgroundImage = `url(${project.background_image_link})`;
                    card.querySelector('#card-body').style.backgroundSize = 'cover';
                    card.querySelector('#card-body').style.backgroundPosition = 'center';
                    card.querySelector('#card-body').style.backgroundRepeat = 'no-repeat';
                    card.querySelector('#card-body').style.borderRadius = '25px'; 
                    */

                    // incrémenter le stepper
                    stepper++;
                    if (stepper === 3) {
                        card = document.createElement('div');
                        stepper = 0;
                    }
                });
            })
    });
</script>