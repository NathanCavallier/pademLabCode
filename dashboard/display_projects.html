<body>
    <!-- Afficher le menu de navigation -->
    <div style="display: flex; justify-content: space-between;">
        <div style="margin-top: 10px; margin-bottom: 10px"></div>

        <!-- Boutons de trie -->
        <div style="display: flex; justify-content: flex-end, space-evenly;">
            <button class="button" id="all" onclick="getButtonId('all'); setFilter(null);"
                style="margin: 10px; padding: 10px; border-radius: 15px; border-color: gray; background-color: white; color: gray; font-size: 12px; width: fit-content;">
                Tout</button>
            <button class="button" id="en_cours" onclick="getButtonId('en_cours'); setFilter('En cours');"
                style="margin: 10px; padding: 10px; border-radius: 15px; border-color: gray; background-color: white; color: gray; font-size: 12px; width: fit-content;">
                En cours</button>
            <button class="button" id="en_attente"
                onclick="getButtonId('en_attente'); setFilter('Pas encore commencé');"
                style="margin: 10px; padding: 10px; border-radius: 15px; border-color: gray; background-color: white; color: gray; font-size: 12px; width: fit-content;">
                En attente</button>
            <button class="button" id="annule" onclick="getButtonId('annule'); setFilter('Annulé');"
                style="margin: 10px; padding: 10px; border-radius: 15px; border-color: gray; background-color: white; color: gray; font-size: 12px; width: fit-content;">
                Annulés</button>
            <button class="button" id="presque_termine"
                onclick="getButtonId('presque_termine'); setFilter('Presque terminé');"
                style="margin: 10px; padding: 10px; border-radius: 15px; border-color: gray; background-color: white; color: gray; font-size: 12px; width: fit-content;">
                Bientôt terminé</button>
            <button class="button" id="termine" onclick="getButtonId('termine'); setFilter('Terminé');"
                style="margin: 10px; padding: 10px; border-radius: 15px; border-color: gray; background-color: white; color: gray; font-size: 12px; width: fit-content;">
                Terminés</button>
        </div>
    </div>
    <!-- Afficher la liste des projets en cours -->
    <div id="projectContainer">
    </div>
</body>


<script>
    // Récupérer le nombre d'utilisateurs inscrits sur le site via l'API (https://lab.padem.org/wp-json/mo/v1/getUserEmailAndState)
    var numberOfMembers = 0;
    var numberOfMembersOnline = 0;
    var nomberOfNewReports = 0;
    var numberOfNewMessages = 0;
    var numberOfNewNotifications = 0;
    var connectedUsers = {};

    // Récupérer les informations de l'utilisateur connecté
    var userId;
    var userEmail = '';
    var userFirstName = '';
    var userLastName = '';
    var userRole = [];
    var buttonText = '';

    // Récupérer le nombre d'utilisateurs inscrits sur le site
    function getNumberOfMembers() {
        // Récupérer le nombre d'utilisateurs inscrits sur le site
        fetch('https://lab.padem.org/wp-json/mo/v1/getUserEmailAndState', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(response => response.json())
            .then(data => {
                numberOfMembers = data.length;
                data.forEach(user => {
                    // Faire en sorte que le nombre d'utilisateurs connectés n'ogmente pas si l'utilisateur est déjà connecté
                    if (!connectedUsers[user.user_email]) {
                        connectedUsers[user.user_email] = 1;
                        if (user.user_status === 1) {
                            numberOfMembersOnline++;
                        }
                    }
                });
                // Récupérer le nombre d'utilisateurs actuellement connectés sur le site
                if (numberOfMembersOnline === 1 || numberOfMembersOnline === 0) {
                    document.getElementById('numberOfMembersOnline').innerHTML = '0 ';
                } else {
                    document.getElementById('numberOfMembersOnline').innerHTML = (numberOfMembersOnline - 1) + ' ';
                }
                document.getElementById('numberOfMembers').innerHTML = numberOfMembers;
            })
    }

    // Rafraîchir le nombre d'utilisateurs connectés toutes les 5 secondes
    setInterval(getNumberOfMembers, 5000);

    // Récupérer les informations de l'utilisateur connecté
    function getConnectedUserInfos() {
        // Récupérer les informations de l'utilisateur connecté
        fetch('https://lab.padem.org/unserialize_usermeta.php', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                userId = data.user_infos._id;
                userEmail = data.user_infos.email;
                userFirstName = data.user_infos.first_name;
                userLastName = data.user_infos.last_name;
                if (data.role.administrator) {
                    userRole.push('Administrateur');
                } else if (data.role['chef-de-projet']) {
                    userRole.push('Chef de projet');
                } else if (data.role.comptable) {
                    userRole.push('Comptable');
                } else if (data.role.consultant) {
                    userRole.push('Consultant');
                } else if (data.role.partenaire) {
                    userRole.push('Partenaire');
                } else if (data.role.subscriber) {
                    userRole.push('Abonné');
                } else {
                    userRole.push('Utilisateur');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    // Projet: Récurérer les données depuis la base de données et les afficher dans des cellules individuels cliquables pour les modifier
    var filter = null;

    function getButtonId(id) {
        switch (id) {
            case 'all':
                filter = null;
                document.getElementById('all').style.backgroundColor = 'gray';
                document.getElementById('all').style.color = 'white';
                document.getElementById('en_cours').style.backgroundColor = 'white';
                document.getElementById('en_cours').style.color = 'gray';
                document.getElementById('en_attente').style.backgroundColor = 'white';
                document.getElementById('en_attente').style.color = 'gray';
                document.getElementById('annule').style.backgroundColor = 'white';
                document.getElementById('annule').style.color = 'gray';
                document.getElementById('presque_termine').style.backgroundColor = 'white';
                document.getElementById('presque_termine').style.color = 'gray';
                document.getElementById('termine').style.backgroundColor = 'white';
                document.getElementById('termine').style.color = 'gray';
                break;
            case 'en_cours':
                filter = 'En cours';
                document.getElementById('all').style.backgroundColor = 'white';
                document.getElementById('all').style.color = 'gray';
                document.getElementById('en_cours').style.backgroundColor = 'gray';
                document.getElementById('en_cours').style.color = 'white';
                document.getElementById('en_attente').style.backgroundColor = 'white';
                document.getElementById('en_attente').style.color = 'gray';
                document.getElementById('annule').style.backgroundColor = 'white';
                document.getElementById('annule').style.color = 'gray';
                document.getElementById('presque_termine').style.backgroundColor = 'white';
                document.getElementById('presque_termine').style.color = 'gray';
                document.getElementById('termine').style.backgroundColor = 'white';
                document.getElementById('termine').style.color = 'gray';
                break;
            case 'termine':
                filter = 'Terminé';
                document.getElementById('all').style.backgroundColor = 'white';
                document.getElementById('all').style.color = 'gray';
                document.getElementById('en_cours').style.backgroundColor = 'white';
                document.getElementById('en_cours').style.color = 'gray';
                document.getElementById('en_attente').style.backgroundColor = 'white';
                document.getElementById('en_attente').style.color = 'gray';
                document.getElementById('annule').style.backgroundColor = 'white';
                document.getElementById('annule').style.color = 'gray';
                document.getElementById('presque_termine').style.backgroundColor = 'white';
                document.getElementById('presque_termine').style.color = 'gray';
                document.getElementById('termine').style.backgroundColor = 'gray';
                document.getElementById('termine').style.color = 'white';
                break;
            case 'annule':
                filter = 'Annulé';
                document.getElementById('all').style.backgroundColor = 'white';
                document.getElementById('all').style.color = 'gray';
                document.getElementById('en_cours').style.backgroundColor = 'white';
                document.getElementById('en_cours').style.color = 'gray';
                document.getElementById('en_attente').style.backgroundColor = 'white';
                document.getElementById('en_attente').style.color = 'gray';
                document.getElementById('annule').style.backgroundColor = 'gray';
                document.getElementById('annule').style.color = 'white';
                document.getElementById('presque_termine').style.backgroundColor = 'white';
                document.getElementById('presque_termine').style.color = 'gray';
                document.getElementById('termine').style.backgroundColor = 'white';
                document.getElementById('termine').style.color = 'gray';
                break;
            case 'en_attente':
                filter = 'Pas encore commencé';
                document.getElementById('all').style.backgroundColor = 'white';
                document.getElementById('all').style.color = 'gray';
                document.getElementById('en_cours').style.backgroundColor = 'white';
                document.getElementById('en_cours').style.color = 'gray';
                document.getElementById('en_attente').style.backgroundColor = 'gray';
                document.getElementById('en_attente').style.color = 'white';
                document.getElementById('annule').style.backgroundColor = 'white';
                document.getElementById('annule').style.color = 'gray';
                document.getElementById('presque_termine').style.backgroundColor = 'white';
                document.getElementById('presque_termine').style.color = 'gray';
                document.getElementById('termine').style.backgroundColor = 'white';
                document.getElementById('termine').style.color = 'gray';
                break;
            case 'presque_termine':
                filter = 'Presque terminé';
                document.getElementById('all').style.backgroundColor = 'white';
                document.getElementById('all').style.color = 'gray';
                document.getElementById('en_cours').style.backgroundColor = 'white';
                document.getElementById('en_cours').style.color = 'gray';
                document.getElementById('en_attente').style.backgroundColor = 'white';
                document.getElementById('en_attente').style.color = 'gray';
                document.getElementById('annule').style.backgroundColor = 'white';
                document.getElementById('annule').style.color = 'gray';
                document.getElementById('presque_termine').style.backgroundColor = 'gray';
                document.getElementById('presque_termine').style.color = 'white';
                document.getElementById('termine').style.backgroundColor = 'white';
                document.getElementById('termine').style.color = 'gray';
                break;
        }
    }

    function setFilter(status) {
        filter = status;
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Déclarer les variables
        var numberOfMembers = 0;
        var nomberOfNewReports = 0;
        var numberOfNewMessages = 0;
        var numberOfNewNotifications = 0;

        var colorStatusText = {
            'Pas encore commencé': 'gray',
            'Début': '#29A6A7',
            'En cours': 'green',
            'Terminé': 'red',
            'En pause': 'blue',
            'Annulé': 'gray',
            'Presque terminé': 'orange',
        };

        function getMonth(month) {
            switch (month) {
                case 1:
                    return 'Janvier';
                case 2:
                    return 'Février';
                case 3:
                    return 'Mars';
                case 4:
                    return 'Avril';
                case 5:
                    return 'Mai';
                case 6:
                    return 'Juin';
                case 7:
                    return 'Juillet';
                case 8:
                    return 'Août';
                case 9:
                    return 'Septembre';
                case 10:
                    return 'Octobre';
                case 11:
                    return 'Novembre';
                case 12:
                    return 'Décembre';
            }
        }

        // Récupérer le nombre d'utilisateurs inscrits sur le site et le nombre d'utilisateurs actuellement connectés
        getNumberOfMembers();

        // Récupérer la liste des projets depuis la base de données (à partir de l'API (https://lab.padem.org/wp-json/mo/v1/getProjects))
        // les projets sont affichés dans des cartes individuelles
        fetch('https://lab.padem.org/wp-json/mo/v1/getProjects', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(response => response.json())
            .then(data => {
                var stepper = 0;
                var isUserInOneProject = false;
                var projectContainer = document.getElementById('projectContainer');
                // Parcourir la liste des projets
                data.forEach(project => {

                    var card = document.createElement('div');
                    card.className = 'card';
                    card.style.borderRadius = '15px';
                    card.style.backgroundColor = 'white';
                    card.style.height = 'auto';
                    card.style.width = 'auto';
                    card.style.margin = '10px';
                    card.style.border = '1px' + `${colorStatusText[status]}` + 'solid';

                    var startDate = new Date(project.start_date);
                    var endDate = new Date(project.end_date);
                    var dateDuJour = new Date();

                    var startDay = startDate.getDate();
                    var startMonth = startDate.getMonth() + 1; // Les mois sont indexés à partir de 0 en JavaScript
                    var startYear = startDate.getFullYear();

                    var endDay = endDate.getDate();
                    var endMonth = endDate.getMonth() + 1;
                    var endYear = endDate.getFullYear();

                    // Si le jour ou le mois est inférieur à 10, ajoutez un zéro devant
                    startDay = startDay < 10 ? '0' + startDay : startDay;
                    endDay = endDay < 10 ? '0' + endDay : endDay;

                    var formattedStartDate = startDay + ' ' + getMonth(startMonth) + ' ' + startYear;
                    var formattedEndDate = endDay + ' ' + getMonth(endMonth) + ' ' + endYear;

                    if (startMonth < 10) {
                        startMonth = '0' + startMonth;
                    } else {
                        startMonth = startMonth;
                    }

                    var dureeTotale = endDate.getTime() - startDate.getTime();
                    var dureeEcoulee = dateDuJour.getTime() - startDate.getTime();

                    var progression = (dureeEcoulee / dureeTotale) * 100;

                    function getStatus() {
                        if (progression < 0) {
                            progression = 0;
                            return 'Pas encore commencé';
                        } else if (progression < 25) {
                            return 'Début';
                        } else if (progression > 25 && progression < 50) {
                            return 'En cours';
                        } else if (progression > 50 && progression < 75) {
                            return 'En cours';
                        } else if (progression > 75 && progression < 100) {
                            return 'Presque terminé';
                        } else {
                            return 'Terminé';
                        }
                    }

                    filter = null;

                    var status = getStatus();

                    var barreProgression = document.createElement('progress');
                    barreProgression.id = 'progress_' + project.project_id;
                    barreProgression.value = progression;
                    barreProgression.max = 100;
                    barreProgression.style.width = '100%';
                    barreProgression.style.height = '10px';
                    barreProgression.style.backgroundColor = 'none';
                    barreProgression.style.borderRadius = '10px';
                    barreProgression.classList.add('animated');
                    setTimeout(function () {
                        barreProgression.classList.remove('animated');
                    }, 1000);

                    card.style.fontSize = '14px'; // Change la taille de la police
                    card.style.fontFamily = 'Arial'; // Change la police
                    card.style.color = 'gray'; // Change la couleur de la police

                    // Vérifier si l'adresse e-mail de l'utilisateur connecté est dans la liste des participants
                    var participants = project.users_list;
                    var isUserInProject = false;
                    participants.forEach(participant => {
                        if (participant.email === userEmail) {
                            isUserInProject = true;
                            isUserInOneProject = true;
                        }
                    });

                    if (isUserInProject) {
                        card.innerHTML = `
                            <div class="card">
                                <div id="card-body" class="card-body" style="backgroundColor: none; ">
                                    <div style="width: 40%; align-items: center;">
                                        <p style="font-weight: lighter; font-size: 10px">${formattedStartDate} - ${formattedEndDate}</p>
                                    </div>
                                    <div style="margin-top: 150px; margin-bottom: 10px"></div>
                                    <a href='https://lab.padem.org/projet/edit_project.html?project_id=${project.project_id}' style="font-size: 20px; font-weight: bold; color: #29A6A7;">${project.project_title}</a>
                                    <div style="margin-top: 0px">
                                        <p style="font-weight: bold;">${project.project_location}</p>
                                    </div>
                                    ${barreProgression.outerHTML}
                                </div>
                                <div class="card-footer">
                                    <p style="font-weight: lighter; color: ${colorStatusText[status]}; margin: 5px; border-radius: 5px; fontSize: 9px;" id="status_${project.project_id}">${parseInt(progression)}% - ${status}</p>
                                    <button class="buttonModifier">Voir le projet</button>
                                </div>
                            </div>
                        `;

                        // Ajouter la cellule dans la ligne
                        projectContainer.appendChild(card);

                        // Ajouter un événement de clic sur le bouton "Modifier" en fonction de l'ID du projet, du rôle de l'utilisateur et en fonction de si l'utilisateur est dans le projet
                        if (userRole.includes('Administrateur') || userRole.includes('Chef de projet')) {
                            card.querySelector('.buttonModifier').addEventListener('click', () => {
                                window.location.href = `https://lab.padem.org/projet/edit_project.html?project_id=${project.project_id}`;
                            });
                        } else if (userRole.includes('Consultant')) {
                            card.querySelector('.buttonModifier').addEventListener('click', () => {
                                window.location.href = `https://lab.padem.org/projet/view_project.html?project_id=${project.project_id}`;
                            });
                        } else if (userRole.includes('Partenaire')) {
                            card.querySelector('.buttonModifier').addEventListener('click', () => {
                                window.location.href = `https://lab.padem.org/projet/view_project.html?project_id=${project.project_id}`;
                            });
                        } else {
                            card.querySelector('.buttonModifier').addEventListener('click', () => {
                                window.location.href = `https://lab.padem.org/projet/view_project.html?project_id=${project.project_id}`;
                            });
                        }

                        // Ajouter l'image en arrière-plan du card-body
                        /*
                        card.querySelector('#card-body').style.backgroundImage = `url(${project.background_image_link})`;
                        card.querySelector('#card-body').style.backgroundSize = 'cover';
                        card.querySelector('#card-body').style.backgroundPosition = 'center';
                        card.querySelector('#card-body').style.backgroundRepeat = 'no-repeat';
                        card.querySelector('#card-body').style.borderRadius = '25px'; 
                        */

                        // incrémenter le stepper
                        stepper++;
                        if (stepper === 3) {
                            card = document.createElement('div');
                            stepper = 0;
                        }
                    }
                });
                if (!isUserInOneProject) {
                    // Afficher un message disant qu'il n'y a pas de projet
                    card.innerHTML = `
                    <p style="color: gray; background: none">
                        Vous n'avez pas de projet pour le moment !
                    </p>`;
                    projectContainer.appendChild(card);
                }
            })
    });
</script>