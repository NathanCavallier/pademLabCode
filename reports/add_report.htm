<!-- Description de la page: Afficher une liste des demandes de rapport à soumettre -->
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>Liste des demandes de rapport à soumettre</h1>
            <table class="table">
                <thead>
                    <tr>
                        <th scope="col">Nom du rapport</th>
                        <th scope="col">Destinataires du rapport</th>
                        <th scope="col">Type de rapport</th>
                        <th scope="col">Contenu du rapport</th>
                        <th scope="col">Fichiers joints</th>
                        <th scope="col">Status du rapport</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="reportsList_">
                    <!-- Les rapports seront affichés ici -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Description de la page: Afficher les informations d'un rapport -->
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>Informations du rapport</h1>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Nom du rapport: </h5>
                    <p class="card-text" id="reportName_"></p>
                    <h5 class="card-title">Destinataires du rapport: </h5>
                    <p class="card-text" id="reportReceivers_"></p>
                    <h5 class="card-title">Type de rapport: </h5>
                    <p class="card-text" id="reportType_"></p>
                    <h5 class="card-title">Contenu du rapport: </h5>
                    <p class="card-text" id="reportContent_"></p>
                    <h5 class="card-title">Fichiers joints: </h5>
                    <p class="card-text" id="reportFiles"></p>
                    <h5 class="card-title">Status du rapport: </h5>
                    <p class="card-text" id="reportStatus_"></p>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Description de la page: Bouton pour afficher/masquer le formulaire d'ajout de rapport -->
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <button type="button" class="btn btn-primary" id="showReportForm"
                style="width: fit-content; color: white; background-color: gray;">
                Ajouter un rapport</button>
        </div>
    </div>
</div>

<!-- Description: Page pour ajouter un rapport d'avancement -->
<div class="container">
    <form id="progressReportForm" style="display: none;">
        <div class="form-group">
            <label for="progressReportName">Nom du rapport: <span style="color: red;">*</span></label>
            <input type="text" class="form-control" id="progressReportName" required>
        </div>
        <div style="margin-top: 5px;"></div>

        <div class="form-group">
            <label for="progressReportType">Type de rapport: <span style="color: red;">*</span></label>
            <select class="form-control" id="progressReportType" required>
                <option value="">Sélectionner le type de rapport</option>
            </select>
        </div>
        <div style="margin-top: 5px;"></div>

        <div class="form-group">
            <label for="progressReportContent">Ajouter des commentaires: <span style="color: red;">*</span></label>
            <textarea class="form-control" id="progressReportContent" rows="4" required></textarea>
        </div>
        <div style="margin-top: 5px;"></div>

        <div class="form-group">
            <label for="progressReportFiles">Saisir tous les noms des fichiers à joindre au rapport: <span
                    style="color: red;">*</span></label>
            <textarea type="text" class="form-control" id="progressReportFiles" rows="6" required></textarea>
        </div>
        <div style="margin-top: 10px;"></div>

        <button type="submit" class="btn btn-primary" id="submitProgressReport"
            style="width: fit-content; color: white;">Soumettre le rapport</button>
    </form>
</div>


<!-- Script pour ajouter un rapport -->

<script>
    // Récupérer les rapports
    document.addEventListener('DOMContentLoaded', function (e) {
        e.preventDefault();
    });

    // Ajouter un événement pour afficher/masquer le formulaire d'ajout de rapport
    document.getElementById('showReportForm').addEventListener('click', function () {
        if (document.getElementById('progressReportForm').style.display === 'none') {
            document.getElementById('progressReportForm').style.display = 'block';
            document.getElementById('showReportForm').innerText = 'Annuler';
            // Vider les champs du formulaire
            document.getElementById('progressReportName').value = '';
            document.getElementById('progressReportType').value = '';
            document.getElementById('progressReportContent').value = '';
            document.getElementById('progressReportFiles').value = '';
        } else {
            document.getElementById('progressReportForm').style.display = 'none';
            document.getElementById('showReportForm').innerText = 'Ajouter un projet';
        }
    });

    // Ajouter un événement pour soumettre le rapport
    document.getElementById('submitProgressReport').addEventListener('click', function (e) {
        e.preventDefault();
        submitReport();
    });

    //#region Fonction récupérer les rapports
    function getReports() {
        //#region Récupérer les rapports qui font partie du projet (https://lab.padem.org/wp-json/mo/v1/getWorkingTable)
        var all_reports_ids = [];
        var project_id = parseInt(new URLSearchParams(window.location.search).get('projectId'));
        fetch('https://lab.padem.org/wp-json/mo/v1/getWorkingTable',
            {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Récupérer l'ID du projet
                data.forEach(working_table => {
                    // Vérifier si le rapport fait partie du projet (dans la table de travail)
                    if (parseInt(working_table.project_id) === project_id) {
                        all_reports_ids.push(working_table.report_id);
                    }
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
        //#endregion

        //#region Récupérer les rapports (https://lab.padem.org/wp-json/mo/v1/getReports)
        fetch('https://lab.padem.org/wp-json/mo/v1/getReports',
            {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Récupérer l'ID du projet
                data.forEach(report => {
                    // Afficher les rapports qui font partie du projet
                    if (all_reports_ids.includes(report.report_id)) {
                        if (report.rapports_avancement !== null) {
                            var li = document.createElement('li');
                            var _report = JSON.parse(report.rapports_avancement);
                            li.innerHTML = `
                                <li class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1" style="color: #29A6A7;">${_report.rapport_name}</h5>
                                            <small>Status du rapport</small>
                                        </div>
                                        <p class="mb-1">${_report.created_date}</p>
                                        <button type="button" class="btn btn-primary" data-toggle="collapse" id="btn_report_${report.report_id}" data-target="#details_${report.report_id}" style="width: fit-content; color: white;">Détails</button>
                                        <div style="margin-top: 15px;"></div>
                                        <div id="details_${report.report_id}" style="display: none;">
                                            <div class="card card-body">
                                                <textarea rows="8" placeholder="Description" style="border-radius: 15px; width: fit-content;" disabled style="width: fit-content;">Commentaires: ${_report.rapport_content}</textarea>
                                                <br>
                                                <div style="color: #29A6A7;">Fichiers à télécharger: ${_report.rapport_files}</div>
                                            </div>
                                        </div>
                                    </li>
                                `;
                            document.getElementById('reportsList_').appendChild(li);
                            document.getElementById(`btn_report_${report.report_id}`).addEventListener('click', function () {
                                if (document.getElementById(`details_${report.report_id}`).style.display === 'none') {
                                    document.getElementById(`details_${report.report_id}`).style.display = 'block';
                                    document.getElementById(`btn_report_${report.report_id}`).innerText = 'Masquer les détails';
                                } else {
                                    document.getElementById(`details_${report.report_id}`).style.display = 'none';
                                    document.getElementById(`btn_report_${report.report_id}`).innerText = 'Détails';
                                }
                            });

                        }
                    }
                });
                if (all_reports_ids.length === 0) {
                    var li = document.createElement('li');
                    li.innerHTML = ` <li class="list-group-item">Aucun rapport trouvé</li>`;
                    document.getElementById('reportsList_').appendChild(li);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        //#endregion
    }
    //#endregion

    // Fonction pour switcher les images des boutons
    function switchFormsIcons(id) {
        var element = document.getElementById(id);
        if (element.src.match("https://lab.padem.org/wp-content/uploads/plus.png")) {
            element.src = "https://lab.padem.org/wp-content/uploads/voire.png";
        } else if (element.src.match("https://lab.padem.org/wp-content/uploads/voire.png")) {
            element.src = "https://lab.padem.org/wp-content/uploads/masquer.png";
        } else {
            element.src = "https://lab.padem.org/wp-content/uploads/voire.png";
        }
    }

    // Fonction pour switcher les images du bouton Ajouter un projet
    function switchAddProjectButtonIcon() {
        var element = document.getElementById("add-file");
        if (element.src.match("https://lab.padem.org/wp-content/uploads/plus.png") && document.getElementById('projectForm_').style.display === 'none') {
            element.src = "https://lab.padem.org/wp-content/uploads/voire.png";
            element.title = "Afficher le formulaire";
            document.getElementById('projectForm_').style.display = 'block';
        } else if ((document.getElementById("cancelProjectButton").style.display === "block") && (element.src.match("https://lab.padem.org/wp-content/uploads/masquer.png"))) {
            element.src = "https://lab.padem.org/wp-content/uploads/voire.png";
            element.title = "Masquer le formulaire";
            document.getElementById('projectForm_').style.display = 'block';
        } else {
            element.src = "https://lab.padem.org/wp-content/uploads/masquer.png";
            element.title = "Afficher le formulaire";
            document.getElementById('projectForm_').style.display = 'none';
        }
    }
</script>


<!-- End of reports/add_report.htm -->