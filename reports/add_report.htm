<!-- Description de la page: Afficher une liste des demandes de rapport à soumettre -->
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>Liste des demandes de rapport à soumettre</h1>
            <table class="table">
                <thead>
                    <tr>
                        <th scope="col">Nom du rapport</th>
                        <th scope="col">Destinataires du rapport</th>
                        <th scope="col">Type de rapport</th>
                        <th scope="col">Contenu du rapport</th>
                        <th scope="col">Fichiers joints</th>
                        <th scope="col">Status du rapport</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="reportsList_">
                    <!-- Les rapports seront affichés ici -->
                </tbody>
            </table>
        </div>
    </div>
</div>


<!-- Description de la page: Afficher les informations d'un rapport -->
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1>Informations du rapport</h1>
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Nom du rapport: </h5>
                    <p class="card-text" id="reportName_"></p>
                    <h5 class="card-title">Destinataires du rapport: </h5>
                    <p class="card-text" id="reportReceivers_"></p>
                    <h5 class="card-title">Type de rapport: </h5>
                    <p class="card-text" id="reportType_"></p>
                    <h5 class="card-title">Contenu du rapport: </h5>
                    <p class="card-text" id="reportContent_"></p>
                    <h5 class="card-title">Fichiers joints: </h5>
                    <p class="card-text" id="reportFiles"></p>
                    <h5 class="card-title">Status du rapport: </h5>
                    <p class="card-text" id="reportStatus_"></p>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- Description de la page: Afficher la liste des rapports d'avancement sous forme de liste (ul et li)-->
<div class="container" style="color: gray;">
    <div class="row">
        <div class="col-md-12">
            <ul class="list-group" id="reportsList_avancement" style="list-style: none;">
                <!-- Les rapports seront affichés ici -->
            </ul>

        </div>
    </div>
</div>


<!-- Description de la page: Afficher la liste des rapports finaux sous forme de liste (ul et li) -->
<div class="container" style="color: gray;">
    <div class="row">
        <div class="col-md-12">
            <ul class="list-group" id="reportsList_final" style="list-style: none;">
                <!-- Les rapports seront affichés ici -->
            </ul>

        </div>
    </div>
</div>


<!-- Description de la page: Bouton pour afficher/masquer le formulaire d'ajout de rapport -->
<div class="container">
    <div class="row">
        <div class="col-md-12">
            <button type="button" class="btn btn-primary" id="showReportForm"
                style="width: fit-content; color: white; background-color: gray;">
                Ajouter un rapport</button>
        </div>
    </div>
</div>

<!-- Description: Page pour ajouter un rapport d'avancement -->
<div class="container">
    <form id="progressReportForm" style="display: none;">
        <div class="form-group">
            <label for="progressReportName">Nom du rapport d'avancement: </label>
            <input type="text" class="form-control" id="progressReportName" required>
        </div>
        <div style="margin-top: 5px;"></div>

        <div class="form-group">
            <label for="progressReportType">Type de rapport: </label>
            <select class="form-control" id="progressReportType" required>
                <option value="progress">Rapport d'avancement</option>
                <option value="final">Rapport final</option>
            </select>
        </div>
        <div style="margin-top: 5px;"></div>

        <div class="form-group">
            <label for="progressReportContent">Ajouter des commentaires:</label>
            <textarea class="form-control" id="progressReportContent" rows="4" required></textarea>
        </div>
        <div style="margin-top: 5px;"></div>

        <div class="form-group">
            <label for="progressReportFiles">Saisir tous les noms des fichiers à joindre au rapport: </label>
            <textarea type="text" class="form-control" id="progressReportFiles" rows="6" required></textarea>
        </div>
        <div style="margin-top: 10px;"></div>

        <button type="submit" class="btn btn-primary" id="submitProgressReport"
            style="width: fit-content; color: white;">Soumettre le rapport</button>
    </form>
</div>


<!-- Script pour ajouter un rapport -->

<script>
    // Récupérer les rapports
    document.addEventListener('DOMContentLoaded', function (e) {
        e.preventDefault();
        getReports();
    });

    // Ajouter un événement pour afficher/masquer le formulaire d'ajout de rapport
    document.getElementById('showReportForm').addEventListener('click', function () {
        if (document.getElementById('progressReportForm').style.display === 'none') {
            document.getElementById('progressReportForm').style.display = 'block';
            document.getElementById('showReportForm').innerText = 'Annuler';
            // Vider les champs du formulaire
            document.getElementById('progressReportName').value = '';
            document.getElementById('progressReportType').value = '';
            document.getElementById('progressReportContent').value = '';
            document.getElementById('progressReportFiles').value = '';
        } else {
            document.getElementById('progressReportForm').style.display = 'none';
            document.getElementById('showReportForm').innerText = 'Ajouter un projet';
        }
    });

    // Ajouter un événement pour soumettre le rapport
    document.getElementById('submitProgressReport').addEventListener('click', function (e) {
        e.preventDefault();
        submitReport();
    });

    //#region Fonction pour soumettre le rapport
    function submitReport() {
        var reportName = document.getElementById('progressReportName').value;
        var reportType = document.getElementById('progressReportType').value;
        var reportContent = document.getElementById('progressReportContent').value;
        var reportFiles = document.getElementById('progressReportFiles').value;
        var project_id = parseInt(new URLSearchParams(window.location.search).get('projectId'));

        if (reportName === '' || reportType === '' || reportContent === '' || reportFiles === '') {
            Swal.fire({
                icon: 'error',
                title: 'Erreur',
                text: 'Veuillez remplir tous les champs'
            });
            return;
        }

        var users_list = {
            'emails_names': {
                'Coordinateur': 'coordinator_email',
                'Chef de projet': 'chief_email',
                'partenaire': 'partner_email',
                'comptable': 'accountant_email',
                'consultant': 'consultant_email',
                'bailleur': 'funder_email'
            },
            'users': {
                'Coordinateur': [],
                'Chef de projet': [],
                'partenaire': [],
                'comptable': [],
                'consultant': [],
                'bailleur': []
            },
            'urls': {
                'Administrateur': 'https://lab.padem.org/wp-json/mo/v1/getProjectChief',
                'Coordinateur': 'https://lab.padem.org/wp-json/mo/v1/getCoordinator',
                'Chef de projet': 'https://lab.padem.org/wp-json/mo/v1/getProjectChief',
                'partenaire': 'https://lab.padem.org/wp-json/mo/v1/getPartner',
                'comptable': 'https://lab.padem.org/wp-json/mo/v1/getAccountant',
                'consultant': 'https://lab.padem.org/wp-json/mo/v1/getConsultant',
                'bailleur': 'https://lab.padem.org/wp-json/mo/v1/getFunder'
            }
        };

        var reportReceivers = new Array();
        // Récupérer le référent du projet
        var referent = document.getElementById('projectReferentEmail_').value;
        reportReceivers.push(referent);
        // Récupérer les destinataires (Coordinateur, Chef de projet, partenaire, comptable, consultant, bailleur du projet)
        for (var key in users_list.emails_names) {
            var url = users_list.urls[key];
            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.project_id === project_id) {
                            users_list.users[key] = data.email;
                            reportReceivers.push(data[users_list.emails_names[key]]);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        var rapports_avancement = {};
        var rapports_finaux = {};

        if (reportType === 'progress') {
            rapports_avancement = {
                'rapport_name': reportName,
                'rapport_receivers': reportReceivers,
                'rapport_type': reportType,
                'rapport_content': reportContent,
                'rapport_files': reportFiles,
                'created_date': new Date().toLocaleString(),
            };
            rapports_finaux = null;
        } else {
            rapports_finaux = {
                'rapport_name': reportName,
                'rapport_receivers': reportReceivers,
                'rapport_type': reportType,
                'rapport_content': reportContent,
                'rapport_files': reportFiles,
                'created_date': new Date().toLocaleString(),
            };
            rapports_avancement = null;
        }


        var data = {
            'project_id': project_id,
            'rapports_avancement': JSON.stringify(rapports_avancement),
            'rapports_finaux': JSON.stringify(rapports_finaux)
        };

        fetch('https://lab.padem.org/wp-json/mo/v1/createReport', {
            method: 'POST',
            body: JSON.stringify(data),
        })
            .then(response => response.json())
            .then(data => {
                Swal.fire({
                    icon: 'success',
                    title: 'Succès',
                    text: 'Le rapport a été soumis avec succès'
                });
                document.getElementById('progressReportForm').reset() = 'none';
                document.getElementById('showReportForm').innerText = 'Ajouter un projet';
                getReports();
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    //#endregion

    //#region Fonction récupérer les rapports
    function getReports() {
        fetch('https://lab.padem.org/wp-json/mo/v1/getReports',
            {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                var project_id = parseInt(new URLSearchParams(window.location.search).get('projectId'));
                console.log('ID du projet: ', project_id);
                console.log(data);
                data.forEach(report => {
                    if (parseInt(report.project_id) === project_id) {
                        if (report.rapports_avancement !== null) {
                            var li = document.createElement('li');
                            var _report = JSON.parse(report.rapports_avancement);
                            li.innerHTML = `
                                <li class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1" style="color: #29A6A7;">${_report.rapport_name}</h5>
                                            <small>Status du rapport</small>
                                        </div>
                                        <p class="mb-1">${_report.created_date}</p>
                                        <button type="button" class="btn btn-primary" data-toggle="collapse" id="btn_report_${report.report_id}" data-target="#details_${report.report_id}" style="width: fit-content; color: white;">Détails</button>
                                        <div style="margin-top: 15px;"></div>
                                        <div id="details_${report.report_id}" style="display: none;">
                                            <div class="card card-body">
                                                <textarea rows="8" placeholder="Description" style="border-radius: 15px; width: fit-content;" disabled style="width: fit-content;">Commentaires: ${_report.rapport_content}</textarea>
                                                <br>
                                                <div style="color: #29A6A7;">Fichiers à télécharger: ${_report.rapport_files}</div>
                                            </div>
                                        </div>
                                    </li>
                                `;
                            document.getElementById('reportsList_avancement').appendChild(li);
                            document.getElementById(`btn_report_${report.report_id}`).addEventListener('click', function () {
                                if (document.getElementById(`details_${report.report_id}`).style.display === 'none') {
                                    document.getElementById(`details_${report.report_id}`).style.display = 'block';
                                    document.getElementById(`btn_report_${report.report_id}`).innerText = 'Masquer les détails';
                                } else {
                                    document.getElementById(`details_${report.report_id}`).style.display = 'none';
                                    document.getElementById(`btn_report_${report.report_id}`).innerText = 'Détails';
                                }
                            });

                        } else if (report.rapports_finaux !== null) {
                            var li = document.createElement('li');
                            var _report = JSON.parse(report.rapports_finaux);
                            li.innerHTML = `
                                <li class="list-group-items">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1"  style="color: #29A6A7;">${_report.rapport_name}</h5>
                                            <small>Status du rapport</small>
                                        </div>
                                        <p class="mb-1">${_report.created_date}</p>
                                        <button type="button" class="btn btn-primary" data-toggle="collapse" id="btn_report_${report.report_id}" data-target="#details_${report.report_id}" style="width: fit-content; color: white;">Détails</button>
                                        <div style="margin-top: 15px;"></div>
                                        <div id="details_${report.report_id}" class="collapse">
                                            <div class="card card-body">
                                                <textarea rows="8" placeholder="Description" style="border-radius: 15px; width: fit-content;" disabled>Commentaires: ${_report.rapport_content}</textarea>
                                                <br>
                                                <div style="color: #29A6A7;">Fichiers à télécharger: ${_report.rapport_files}</div>
                                            </div>
                                        </div>
                                    </li>
                                `;
                            document.getElementById('reportsList_final').appendChild(li);
                            document.getElementById(`btn_report_${report.report_id}`).addEventListener('click', function () {
                                if (document.getElementById(`details_${report.report_id}`).style.display === 'none') {
                                    document.getElementById(`details_${report.report_id}`).style.display = 'block';
                                    document.getElementById(`btn_report_${report.report_id}`).innerText = 'Masquer les détails';
                                } else {
                                    document.getElementById(`details_${report.report_id}`).style.display = 'none';
                                    document.getElementById(`btn_report_${report.report_id}`).innerText = 'Détails';
                                }
                            });
                        } else {
                            var li = document.createElement('li');
                            li.innerHTML = ` <li class="list-group-item">Aucun rapport trouvé</li>`;
                            document.getElementById('reportsList_avancement').appendChild(li);
                            document.getElementById('reportsList_final').appendChild(li);
                        }
                    }
                });

            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    //#endregion

    // Fonction pour switcher les images des boutons
    function switchFormsIcons(id) {
        var element = document.getElementById(id);
        if (element.src.match("https://lab.padem.org/wp-content/uploads/plus.png")) {
            element.src = "https://lab.padem.org/wp-content/uploads/voire.png";
        } else if (element.src.match("https://lab.padem.org/wp-content/uploads/voire.png")) {
            element.src = "https://lab.padem.org/wp-content/uploads/masquer.png";
        } else {
            element.src = "https://lab.padem.org/wp-content/uploads/voire.png";
        }
    }

    // Fonction pour switcher les images du bouton Ajouter un projet
    function switchAddProjectButtonIcon() {
        var element = document.getElementById("add-file");
        if (element.src.match("https://lab.padem.org/wp-content/uploads/plus.png") && document.getElementById('projectForm_').style.display === 'none') {
            element.src = "https://lab.padem.org/wp-content/uploads/voire.png";
            element.title = "Afficher le formulaire";
            document.getElementById('projectForm_').style.display = 'block';
        } else if ((document.getElementById("cancelProjectButton").style.display === "block") && (element.src.match("https://lab.padem.org/wp-content/uploads/masquer.png"))) {
            element.src = "https://lab.padem.org/wp-content/uploads/voire.png";
            element.title = "Masquer le formulaire";
            document.getElementById('projectForm_').style.display = 'block';
        } else {
            element.src = "https://lab.padem.org/wp-content/uploads/masquer.png";
            element.title = "Afficher le formulaire";
            document.getElementById('projectForm_').style.display = 'none';
        }
    }
</script>


<!-- End of reports/add_report.htm -->