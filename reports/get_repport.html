<!-- Description de la page: Afficher la liste des rapports sous forme de liste (ul et li)-->
<div class="container" style="color: gray;">
    <div class="row">
        <div class="col-md-12">
            <ul class="list-group" id="reportsList_" style="list-style: none;">
                <!-- Les rapports seront affichés ici -->
            </ul>
        </div>
    </div>
</div>


<script>
    
    document.addEventListener('DOMContentLoaded', function () {
        getReports();
    });

    //#region Fonction récupérer les rapports
    function getReports() {
        //#region Récupérer les rapports qui font partie du projet (https://lab.padem.org/wp-json/mo/v1/getWorkingTable)
        var all_reports_ids = [];
        var project_id = parseInt(new URLSearchParams(window.location.search).get('projectId'));
        fetch('https://lab.padem.org/wp-json/mo/v1/getWorkingTable',
            {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Récupérer l'ID du projet
                data.forEach(working_table => {
                    // Vérifier si le rapport fait partie du projet (dans la table de travail)
                    if (parseInt(working_table.project_id) === project_id) {
                        all_reports_ids.push(working_table.report_id);
                    }
                });
            })
            .catch(error => {
                console.error('Error:', error);
            });
        //#endregion

        //#region Récupérer les rapports (https://lab.padem.org/wp-json/mo/v1/getReports)
        fetch('https://lab.padem.org/wp-json/mo/v1/getReports',
            {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Récupérer l'ID du projet
                data.forEach(report => {
                    // Afficher les rapports qui font partie du projet
                    if (all_reports_ids.includes(report.report_id)) {
                        if (report.rapports_avancement !== null) {
                            var li = document.createElement('li');
                            var _report = JSON.parse(report.rapports_avancement);
                            li.innerHTML = `
                                <li class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1" style="color: #29A6A7;">${_report.rapport_name}</h5>
                                            <small>Status du rapport</small>
                                        </div>
                                        <p class="mb-1">${_report.created_date}</p>
                                        <button type="button" class="btn btn-primary" data-toggle="collapse" id="btn_report_${report.report_id}" data-target="#details_${report.report_id}" style="width: fit-content; color: white;">Détails</button>
                                        <div style="margin-top: 15px;"></div>
                                        <div id="details_${report.report_id}" style="display: none;">
                                            <div class="card card-body">
                                                <textarea rows="8" placeholder="Description" style="border-radius: 15px; width: fit-content;" disabled style="width: fit-content;">Commentaires: ${_report.rapport_content}</textarea>
                                                <br>
                                                <div style="color: #29A6A7;">Fichiers à télécharger: ${_report.rapport_files}</div>
                                            </div>
                                        </div>
                                    </li>
                                `;
                            document.getElementById('reportsList_').appendChild(li);
                            document.getElementById(`btn_report_${report.report_id}`).addEventListener('click', function () {
                                if (document.getElementById(`details_${report.report_id}`).style.display === 'none') {
                                    document.getElementById(`details_${report.report_id}`).style.display = 'block';
                                    document.getElementById(`btn_report_${report.report_id}`).innerText = 'Masquer les détails';
                                } else {
                                    document.getElementById(`details_${report.report_id}`).style.display = 'none';
                                    document.getElementById(`btn_report_${report.report_id}`).innerText = 'Détails';
                                }
                            });

                        }
                    }
                });
                if (all_reports_ids.length === 0) {
                    var li = document.createElement('li');
                    li.innerHTML = ` <li class="list-group-item">Aucun rapport trouvé</li>`;
                    document.getElementById('reportsList_').appendChild(li);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        //#endregion
    }
    //#endregion
</script>